<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>针对国内一大厂的后渗透 – 持续 | SY0U&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="0x00 前言  此文将全部脱敏，涉及某大厂商，中间会穿插一些小的知识点与细节。 0x01 信息搜集 – 后渗透  首先我们后渗透阶段的开始表现在 拥有一个Webshell或者通过其他漏洞获取了某些操作服务器文件的权限，亦或者能够直接反弹Shell。 这里我挑选了一个某厂边缘处的一个测试环境，在这之前我做了大量的信息搜集，没有选择直接去挖掘、利用漏洞。  操作系统 Web服务器版本 PHP版本 绝">
<meta property="og:type" content="website">
<meta property="og:title" content="针对国内一大厂的后渗透 – 持续">
<meta property="og:url" content="http://wsygoogol.github.io/针对国内一大厂的后渗透-–-持续.html">
<meta property="og:site_name" content="SY0U&#39;s Blog">
<meta property="og:description" content="0x00 前言  此文将全部脱敏，涉及某大厂商，中间会穿插一些小的知识点与细节。 0x01 信息搜集 – 后渗透  首先我们后渗透阶段的开始表现在 拥有一个Webshell或者通过其他漏洞获取了某些操作服务器文件的权限，亦或者能够直接反弹Shell。 这里我挑选了一个某厂边缘处的一个测试环境，在这之前我做了大量的信息搜集，没有选择直接去挖掘、利用漏洞。  操作系统 Web服务器版本 PHP版本 绝">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/1.webp_.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/2.webp_.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/3.webp_.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/4.webp_.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/6.webp_.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/7.webp_.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/8.webp_.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/9.webp_.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/1.webp_1.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/2.webp_1.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/3.webp_1.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/4.webp_1.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/5.webp_.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/6.webp_1.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/7.webp_1.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/8.webp_1.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/9.webp_1.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/1.webp_2.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/2.webp_2.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/3.webp_2.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/4.webp_3.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/5.webp_1.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/6.webp_2.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/7.webp_2.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/8.webp_2.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/9.webp_2.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/1.webp_3.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/2.webp_3.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/3.webp_3.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/4.webp_4.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/5.webp_2.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/6.webp_3.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/7.webp_3.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/8.webp_3.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/9.webp_3.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/10.webp_.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/1.webp_4.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/2.webp_4.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/3.webp_4.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/4.webp_5.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/6.webp_4.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/7.webp_4.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/9.webp_4.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/1.webp_5.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/2.webp_5.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/3.webp_5.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/4.webp_6.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/5.webp_3.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/6.webp_5.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/7.webp_5.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/8.webp_4.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/9.webp_5.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/9.webp-1.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/1.webp_6.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/2.webp_6.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/3.webp_6.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/4.webp_7.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/5.webp_4.jpg">
<meta property="og:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/6.webp_6.jpg">
<meta property="og:updated_time" content="2018-01-11T08:18:23.961Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="针对国内一大厂的后渗透 – 持续">
<meta name="twitter:description" content="0x00 前言  此文将全部脱敏，涉及某大厂商，中间会穿插一些小的知识点与细节。 0x01 信息搜集 – 后渗透  首先我们后渗透阶段的开始表现在 拥有一个Webshell或者通过其他漏洞获取了某些操作服务器文件的权限，亦或者能够直接反弹Shell。 这里我挑选了一个某厂边缘处的一个测试环境，在这之前我做了大量的信息搜集，没有选择直接去挖掘、利用漏洞。  操作系统 Web服务器版本 PHP版本 绝">
<meta name="twitter:image" content="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/1.webp_.jpg">
  
    <link rel="alternate" href="/atom.xml" title="SY0U&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">SY0U&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://wsygoogol.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="page-undefined" class="article article-type-page" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/针对国内一大厂的后渗透-–-持续.html" class="article-date">
  <time datetime="2018-01-11T08:16:58.000Z" itemprop="datePublished">2018-01-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      针对国内一大厂的后渗透 – 持续
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>0x00 前言</p>
<hr>
<p>此文将全部脱敏，涉及某大厂商，中间会穿插一些小的知识点与细节。</p>
<p>0x01 信息搜集 – 后渗透</p>
<hr>
<p>首先我们后渗透阶段的开始表现在 拥有一个Webshell或者通过其他漏洞获取了某些操作服务器文件的权限，亦或者能够直接反弹Shell。</p>
<p>这里我挑选了一个某厂边缘处的一个测试环境，在这之前我做了大量的信息搜集，没有选择直接去挖掘、利用漏洞。</p>
<ul>
<li>操作系统</li>
<li>Web服务器版本</li>
<li>PHP版本</li>
<li>绝对路径</li>
<li>子域名</li>
<li>开放端口 – 发现开启了防火墙</li>
</ul>
<p>扫描到它存在phpMyadmin，弱口令登录进入，通过常规手法SQL写入shell。<a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/1.webp_.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/1.webp_.jpg" alt="img"></a></p>
<p>通过Webshell的方式进入，肯定是要直接看权限了，但是由于是他们的测试环境，权限相对比较高。</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/2.webp_.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/2.webp_.jpg" alt="img"></a></p>
<p>通过上面的结果可以看到该服务器并不是域成员：</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/3.webp_.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/3.webp_.jpg" alt="img"></a></p>
<p>没有管理员在线：</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/4.webp_.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/4.webp_.jpg" alt="img"></a></p>
<p>可以发现有3389端口，我尝试了去直接连接，但是被拒绝了，绝对是防火墙做了入站限制。</p>
<p>这个尝试是有风险的，因为你不知道下一步的操作能够为自己带来怎样的走向。</p>
<p>再查看一下网卡：</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/6.webp_.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/6.webp_.jpg" alt="img"></a></p>
<p>这个内网地址我就不脱敏了，方便读者阅读后面的操作。</p>
<p><strong>0x02 后渗透的开始</strong></p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/7.webp_.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/7.webp_.jpg" alt="img"></a></p>
<p>首先我要生成一个MSF木马，目标由于是Win 2008支持Powershell，可以直接一句话搞定 :</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/8.webp_.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/8.webp_.jpg" alt="img"></a></p>
<p>这里我是进行了一个端口转发，将公司路由的1131映射到本机的1131。</p>
<p>MSF这边监听1131：<a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/9.webp_.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/9.webp_.jpg" alt="img"></a></p>
<p><strong>ps1encode 项目 ：<a href="https://github.com/CroweCybersecurity/ps1encode" target="_blank" rel="external">https://github.com/CroweCybersecurity/ps1encode</a></strong></p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/1.webp_1.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/1.webp_1.jpg" alt="img"></a></p>
<p>但是期望越大失望越大，目标主机提示语法错误，难道是webshell传输字符串太长有丢失？</p>
<p>我尝试了使用cmd批处理脚本启动，vbs脚本启动，一样无果。</p>
<p>决定不采用powershell了，采用exe：<a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/2.webp_1.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/2.webp_1.jpg" alt="img"></a></p>
<p>执行过程中有时候会出现这类情况：</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/3.webp_1.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/3.webp_1.jpg" alt="img"></a></p>
<p>很明显是生成的木马与操作系统不兼容；</p>
<p>更改为：</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/4.webp_1.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/4.webp_1.jpg" alt="img"></a></p>
<p>使用WebShell执行后：</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/5.webp_.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/5.webp_.jpg" alt="img"></a></p>
<p>权限维持</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/6.webp_1.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/6.webp_1.jpg" alt="img"></a></p>
<p>0x03 关于权限维持的思考</p>
<hr>
<p><strong>persistence 模块</strong><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/7.webp_1.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/7.webp_1.jpg" alt="img"></a></p>
<p>优先介绍这个模块：post/windows/manage/persistence_exe</p>
<p>它用于创建一个反向连接的后门，使被控端主动连接控制端，传统又好用，但是会留下文件。</p>
<p>参数介绍：<a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/8.webp_1.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/8.webp_1.jpg" alt="img"></a></p>
<p><strong>metsvc：</strong></p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/9.webp_1.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/9.webp_1.jpg" alt="img"></a></p>
<p>它是一个正向的连接，不适用于复杂的内网环境。</p>
<p><strong>0x04 端口转发之portfwd详解</strong></p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/1.webp_2.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/1.webp_2.jpg" alt="img"></a><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/2.webp_2.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/2.webp_2.jpg" alt="img"></a></p>
<p>可以看出服务器开启了3389，假设我如果需要连接3389该怎么办呢？ —— 刚才提到了，有防火墙的限制。</p>
<p>使用portfwd<a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/3.webp_2.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/3.webp_2.jpg" alt="img"></a></p>
<p>下面来练习一下（正向转发）。</p>
<p><strong>目的：将内网某台主机的3389转发到本地。</strong></p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/4.webp_3.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/4.webp_3.jpg" alt="img"></a></p>
<p>此时连接本机的1144就相当于连接10.159.63.178。</p>
<p><strong>目的：将内网某台主机端口流量转发到某台外网主机 (可做端口劫持)。</strong><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/5.webp_1.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/5.webp_1.jpg" alt="img"></a></p>
<p>此时访问10.159.63.178的1478端口就相当于访问10.159.191.2的8080端口：</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/6.webp_2.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/6.webp_2.jpg" alt="img"></a></p>
<p>删除条目为1的端口转发：</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/7.webp_2.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/7.webp_2.jpg" alt="img"></a></p>
<p>列出端口转发条目：</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/8.webp_2.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/8.webp_2.jpg" alt="img"></a></p>
<p>清空所有转发。</p>
<p>端口扫描</p>
<p><strong>添加路由表:</strong></p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/9.webp_2.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/9.webp_2.jpg" alt="img"></a></p>
<p>当然在上线前，你就设置好自动添加路由，就不需要去手动添加了：</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/1.webp_3.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/1.webp_3.jpg" alt="img"></a></p>
<p>但是它也有弊端，就是子网太大了，可能会将我们的数据包广播出去，所以最好记一下子网大小，手动灵活添加路由~</p>
<p><strong>扫描：</strong><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/2.webp_3.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/2.webp_3.jpg" alt="img"></a></p>
<p>0x05 Meterpreter</p>
<hr>
<p>获取Hash的几个方式</p>
<p><strong>run hashdump</strong><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/3.webp_3.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/3.webp_3.jpg" alt="img"></a></p>
<p><strong>run powerdump</strong></p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/4.webp_4.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/4.webp_4.jpg" alt="img"></a></p>
<p><strong>load mimikatz kerberos</strong></p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/5.webp_2.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/5.webp_2.jpg" alt="img"></a></p>
<p><strong>run post/windows/gather/smart_hashdump</strong></p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/6.webp_3.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/6.webp_3.jpg" alt="img"></a></p>
<p>0x06 PowerShell技巧</p>
<hr>
<p>外部Powershell脚本</p>
<p><strong>Powersploit**</strong>https:<strong>**//github.com/PowerShellMafia/PowerSploit</strong></p>
<p>第一种办法（推荐）：<a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/7.webp_3.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/7.webp_3.jpg" alt="img"></a></p>
<p>第二种办法：(先通过其他模块下载)：</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/8.webp_3.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/8.webp_3.jpg" alt="img"></a></p>
<p>0x07 再一次克服困难</p>
<hr>
<p>之前的方案是使用Portfwd，但是效果太差了，当数据流过大，会将Meterpreter冲掉，并且每次数据回送都不完整。</p>
<p>这次采用Socks5打洞，我利用了外网的服务器，开设一个Socks代理端口，将流量转发到目标内网。</p>
<p>外网服务器：<a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/9.webp_3.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/9.webp_3.jpg" alt="img"></a></p>
<p>0x07 再一次克服困难</p>
<hr>
<p>之前的方案是使用Portfwd，但是效果太差了，当数据流过大，会将Meterpreter冲掉，并且每次数据回送都不完整。</p>
<p>这次采用Socks5打洞，我利用了外网的服务器，开设一个Socks代理端口，将流量转发到目标内网。</p>
<p>外网服务器：<a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/10.webp_.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/10.webp_.jpg" alt="img"></a></p>
<p>内网主机：</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/1.webp_4.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/1.webp_4.jpg" alt="img"></a></p>
<p><strong>ew下载地址： <a href="http://rootkiter.com/EarthWorm/" target="_blank" rel="external">http://rootkiter.com/EarthWorm/</a></strong></p>
<p>现在在浏览器中设置一下Socks5代理即可访问内网，很稳定。<a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/2.webp_4.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/2.webp_4.jpg" alt="img"></a><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/3.webp_4.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/3.webp_4.jpg" alt="img"></a></p>
<p>0x08 开始扫描</p>
<hr>
<p>一开始我使用PowerSploit扫描，但是需要等待Meterpreter将数据取回，这样就占用了一个session，搜集了部分信息后，决定采用Nmap。</p>
<p>由于我的操作系统是黑苹果，需要安装proxychains-ng。</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/4.webp_5.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/4.webp_5.jpg" alt="img"></a></p>
<p>0x08 开始扫描</p>
<hr>
<p>一开始我使用PowerSploit扫描，但是需要等待Meterpreter将数据取回，这样就占用了一个session，搜集了部分信息后，决定采用Nmap。</p>
<p>由于我的操作系统是黑苹果，需要安装proxychains-ng。</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/6.webp_4.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/6.webp_4.jpg" alt="img"></a></p>
<p>程序安装在：/usr/local/Cellar/proxychains-ng/4.12_1/bin/proxychains4</p>
<p>配置文件：/usr/local/etc/proxychains.conf</p>
<p>添加一条Socks5代理：<a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/7.webp_4.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/7.webp_4.jpg" alt="img"></a></p>
<p>开始扫描：</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/9.webp_4.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/9.webp_4.jpg" alt="img"></a></p>
<p>0x09 信息搜集基本结果</p>
<hr>
<p>通过端口扫描以及HTTP服务的爬行，发现一些运维人员开放的共享，和一些MS17010漏洞的Windows服务器，但是没有选择直接去打，觉得信息搜集的不够全面。</p>
<p>在内网中收获最大的就是搜集到了运维人员用于共享系统镜像、工具的Web服务器：<a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/1.webp_5.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/1.webp_5.jpg" alt="img"></a></p>
<p>发现基线检查的文档，下载了一两个，开始通过搜集的信息进行内网结构画像：</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/2.webp_5.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/2.webp_5.jpg" alt="img"></a><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/3.webp_5.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/3.webp_5.jpg" alt="img"></a></p>
<p>轻松获得域控服务器</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/4.webp_6.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/4.webp_6.jpg" alt="img"></a></p>
<p>从文档中搜集信息如下：</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/5.webp_3.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/5.webp_3.jpg" alt="img"></a></p>
<p>根据之前搜集的子网来判断，我们所处于的内网中有很多域。并且能够可以和域控服务器通信，即使当前的服务器不在域中，也可以进行登录。</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/6.webp_5.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/6.webp_5.jpg" alt="img"></a></p>
<p>通过两层转发，我们尝试登录：</p>
<ul>
<li>一层是公司路由</li>
<li>一层是LCX</li>
</ul>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/7.webp_5.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/7.webp_5.jpg" alt="img"></a></p>
<p>当时登录上去并没有做过多的操作，简单看看就下来了，因为这个内网很大，后面的发现令我倒吸凉气。</p>
<p>0x10 内网核心</p>
<hr>
<p>Orion</p>
<p>这是一款完善的网络带宽、性能和故障管理软件。使用它用户可以通过自己的浏览器即时监控自己的网络状态和统计资料。程序将监视和搜集来自路由、节点、服务器和所有开启SNMP服务的设备信息；同时也将监控本机的CPU占用率、内存使用情况以及可用磁盘空间。</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/8.webp_4.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/8.webp_4.jpg" alt="img"></a></p>
<p>通过空口令进入：</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/9.webp_5.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/9.webp_5.jpg" alt="img"></a></p>
<p>通过查看别名发现这些设备是企业的核心路由、防火墙、交换机。</p>
<ul>
<li>官网防火墙</li>
<li>管理员交换机（专线）</li>
<li>内网核心交换机 x 2</li>
<li>外网核心交换机 x 2</li>
<li>公网接入交换机 x 2</li>
<li>回源 （这个不太清楚）</li>
</ul>
<p>基本上都是50个口以上。</p>
<p>通过之前的自动搜集的路由来看：</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/9.webp-1.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/9.webp-1.jpg" alt="img"></a></p>
<p>10.0.0.0 是可以访问整个超大的内网，在搜集其他网段信息的时候，不泛发现其他大企业的漏洞、大多是配置不得当。</p>
<p><strong>0x12 配置引发的隐患</strong><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/1.webp_6.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/1.webp_6.jpg" alt="img"></a></p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/2.webp_6.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/2.webp_6.jpg" alt="img"></a></p>
<p>还有未做权限验证的Docker集群管理平台：</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/3.webp_6.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/3.webp_6.jpg" alt="img"></a></p>
<p>有多个实例，分别用于对外的服务。</p>
<p>搜集到用户中心的数据库配置，也就是说泄漏了所有用户的数据了，这可是一个大厂。<a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/4.webp_7.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/4.webp_7.jpg" alt="img"></a></p>
<p>其次一些网段基本上都安装了tomcat，通过socks5代理，进行爆破，流量不走Meterpreter，因为会掉线。</p>
<p><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/5.webp_4.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/5.webp_4.jpg" alt="img"></a><a href="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/6.webp_6.jpg" target="_blank" rel="external"><img src="https://static-js.b0.upaiyun.com/wp-content/uploads/2018/01/6.webp_6.jpg" alt="img"></a></p>
<p>如我所料，没有一个成功的，也发现了一些SSH端口，但是会把流量升高，触发一些警报，就没有再尝试这种爆破手法了。</p>
<p>0x13 需要搜集的信息</p>
<hr>
<p>搜集的信息列出来，就不贴了：</p>
<ul>
<li>服务器当前所在网段的所有主机端口</li>
<li>服务器ARP缓存</li>
<li>服务器上的服务</li>
<li>内网中其他HTTP服务</li>
<li>满足容易利用的漏洞端口 （MS17010 / 445）</li>
<li>抓包嗅探还是很有必要的 （千万不要ARP %@#@@651#@^#@@#@@###@@!）</li>
<li>共享文件</li>
<li>密码</li>
</ul>
<p>0x14 总结</p>
<hr>
<ul>
<li>在行动之前思考几分钟，有没有更好的办法</li>
<li>思考一个问题多个解决方案的利弊</li>
<li>尽量快速熟悉网络环境 -&gt; [前提是你已经熟悉了服务器环境]</li>
<li>对日志要时刻保持敏感</li>
<li>看子网掩码、计算子网大小，判断有没有VLAN</li>
<li>选取自己熟悉的协议进行信息搜集</li>
<li>网络命令一定要熟</li>
<li>对于后门要加强维护</li>
<li>你必须保证你花费98%的时间都在了解他们</li>
<li>学习使用Powershell和熟练掌握端口转发</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://wsygoogol.github.io/针对国内一大厂的后渗透-–-持续.html" data-id="cjptbfkc4000nd89lz139vcfn" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/12/17/攻击者利用CertUtil-exe植入恶意软件/">攻击者利用CertUtil.exe植入恶意软件</a>
          </li>
        
          <li>
            <a href="/2018/09/17/Satori-物联网蠕虫分析/">Satori 物联网蠕虫分析</a>
          </li>
        
          <li>
            <a href="/2018/09/14/Suricata-tips/">Suricata tips</a>
          </li>
        
          <li>
            <a href="/2018/09/11/开源情报收集/">开源情报收集</a>
          </li>
        
          <li>
            <a href="/2018/09/06/构建SOC的机器学习分析模型/">构建SOC的机器学习分析模型</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <!--
<footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 SY0U<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
-->

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>